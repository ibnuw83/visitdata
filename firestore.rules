rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
  
    // Aturan yang Diperbaiki: Izinkan semua pengguna terautentikasi untuk MEMBACA data pengguna.
    // Ini menyelesaikan masalah di mana aplikasi tidak dapat memverifikasi profil setelah login.
    // Izin TULIS tetap dibatasi.
    match /users/{userId} {
      allow read: if request.auth != null;
      allow write: if request.auth.uid == userId || request.auth.token.role == 'admin';
    }

    // Admin memiliki akses penuh ke semua koleksi lain.
    match /destinations/{destinationId} {
      allow read: if true; // Data publik
      allow write: if request.auth.token.role == 'admin';
    }

    match /categories/{categoryId} {
      allow read: if true; // Data publik
      allow write: if request.auth.token.role == 'admin';
    }
    
    match /countries/{countryId} {
      allow read: if true; // Data publik
      allow write: if request.auth.token.role == 'admin';
    }

    match /unlock-requests/{requestId} {
      allow read: if request.auth.token.role == 'admin';
      allow create: if request.auth.uid == request.resource.data.requestedBy;
      allow update: if request.auth.token.role == 'admin';
      allow delete: if request.auth.token.role == 'admin';
    }

    match /settings/app {
      allow read: if true; // Data publik
      allow write: if request.auth.token.role == 'admin';
    }

    // Aturan untuk sub-koleksi 'visits'
    match /destinations/{destinationId}/visits/{visitId} {
      allow read: if true; // Data publik
      allow write: if request.auth.token.role == 'admin' 
                   || (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.assignedLocations.hasAny([destinationId]));
    }
  }
}
