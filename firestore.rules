rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
  
    // --- Helper Functions ---
    // Checks if the user is authenticated.
    function isSignedIn() {
      return request.auth != null;
    }
    
    // Checks if the user is an admin by looking at custom claims.
    // The 'role' claim must be set via a server-side process (e.g., Firebase Admin SDK).
    function isAdmin() {
      return isSignedIn() && request.auth.token.role == 'admin';
    }

    // --- Collection Rules ---

    // Users Collection
    match /users/{userId} {
      // ANY signed-in user can CREATE their own user profile document.
      allow create: if isSignedIn() && request.auth.uid == userId;

      // Users can only GET their OWN document. Admins can get ANY user document.
      allow get: if (isSignedIn() && request.auth.uid == userId) || isAdmin();
      
      // Users can only UPDATE their OWN document. Admins can update ANY user document.
      allow update: if (isSignedIn() && request.auth.uid == userId) || isAdmin();
      
      // Only Admins can DELETE a user document.
      allow delete: if isAdmin();
      
      // Only Admins can LIST all users.
      allow list: if isAdmin();
    }
    
    // Categories Collection
    match /categories/{categoryId} {
        // Admins can manage categories. All signed-in users can read them.
        allow read: if isSignedIn();
        allow write: if isAdmin();
    }
    
    // Countries Collection
    match /countries/{countryId} {
        // Admins can manage countries. All signed-in users can read them.
        allow read: if isSignedIn();
        allow write: if isAdmin();
    }
    
    // Destinations Collection
    match /destinations/{destinationId} {
        // All users (including public, not signed-in) can view destinations.
        allow read: if true;
        // Only Admins can create, update, or delete destinations.
        allow write: if isAdmin();

        // Sub-collection for Visit Data
        match /visits/{visitId} {
            // Public can read visit data for reports.
            allow read: if true;
            // Admins or assigned managers can write to visit data.
            // (This is a simplified rule; a more complex rule could check assignedLocations).
            allow write: if isSignedIn(); 
        }
    }
    
    // Unlock Requests Collection
    match /unlock-requests/{requestId} {
        // Admins can read/write all requests.
        // Users can only create requests and read their own.
        allow read, write: if isAdmin();
        allow create: if isSignedIn() && request.resource.data.requestedBy == request.auth.uid;
    }
    
    // Settings Collection
    match /settings/app {
        // Public can read app settings for UI.
        allow read: if true;
        // Only admins can change app settings.
        allow write: if isAdmin();
    }
  }
}
